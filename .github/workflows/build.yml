name: Build macOS Screensaver

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
    
    - name: Verify Swift version
      run: swift --version
    
    - name: Create MacOS directory
      run: mkdir -p SpaceInvadersScreensaver.saver/Contents/MacOS
    
    - name: Build Screensaver (Universal Binary for macOS 13+)
      run: |
        swiftc \
          -target x86_64-apple-macosx13.0 \
          -target arm64-apple-macosx13.0 \
          -framework Cocoa \
          -framework ScreenSaver \
          -framework WebKit \
          -emit-library \
          -o SpaceInvadersScreensaver.saver/Contents/MacOS/SpaceInvadersScreensaver \
          SpaceInvadersScreensaver.swift
    
    - name: Verify binary
      run: |
        ls -lh SpaceInvadersScreensaver.saver/Contents/MacOS/
        file SpaceInvadersScreensaver.saver/Contents/MacOS/SpaceInvadersScreensaver
        echo "Binary created successfully for macOS 13.0+"
    
    - name: Create ZIP
      run: |
        zip -r SpaceInvadersScreensaver.zip SpaceInvadersScreensaver.saver
    
    - name: Upload Screensaver
      uses: actions/upload-artifact@v4
      with:
        name: SpaceInvadersScreensaver
        path: SpaceInvadersScreensaver.zip
        retention-days: 90
