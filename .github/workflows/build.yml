name: Build macOS Screensaver

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.arch }}
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: macos-latest
            target: arm64-apple-macosx13.0
          - arch: x86_64
            runner: macos-15-intel
            target: x86_64-apple-macosx13.0

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Swift version
        run: swift --version

      - name: Build (single-arch)
        run: |
          set -e
          mkdir -p build/${{ matrix.arch }}

          swiftc \
            -target ${{ matrix.target }} \
            -framework Cocoa \
            -framework ScreenSaver \
            -framework WebKit \
            -emit-library \
            -o build/${{ matrix.arch }}/SpaceInvadersScreensaver \
            SpaceInvadersScreensaver.swift

          file build/${{ matrix.arch }}/SpaceInvadersScreensaver

      - name: Upload arch artifact
        uses: actions/upload-artifact@v4
        with:
          name: screensaver-${{ matrix.arch }}
          path: build/${{ matrix.arch }}/SpaceInvadersScreensaver
          retention-days: 7

  package:
    name: Package Universal .saver
    needs: build
    runs-on: macos-15-intel

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download arch artifacts
        uses: actions/download-artifact@v4
        with:
          path: build

      - name: Prepare .saver bundle from repo template
        run: |
          set -e
          rm -rf dist
          mkdir -p dist
          cp -R SpaceInvadersScreensaver.saver dist/SpaceInvadersScreensaver.saver
          mkdir -p dist/SpaceInvadersScreensaver.saver/Contents/MacOS

          echo "Resources:"
          ls -la dist/SpaceInvadersScreensaver.saver/Contents/Resources || true

      - name: Create universal binary (lipo)
        run: |
          set -e
          lipo -create \
            build/screensaver-arm64/SpaceInvadersScreensaver \
            build/screensaver-x86_64/SpaceInvadersScreensaver \
            -output dist/SpaceInvadersScreensaver.saver/Contents/MacOS/SpaceInvadersScreensaver

          chmod +x dist/SpaceInvadersScreensaver.saver/Contents/MacOS/SpaceInvadersScreensaver
          file dist/SpaceInvadersScreensaver.saver/Contents/MacOS/SpaceInvadersScreensaver

      - name: Verify expected files exist
        run: |
          set -e
          test -f dist/SpaceInvadersScreensaver.saver/Contents/Info.plist
          test -f dist/SpaceInvadersScreensaver.saver/Contents/Resources/index.html
          test -f dist/SpaceInvadersScreensaver.saver/Contents/Resources/main.js
          echo "OK: Info.plist + index.html + main.js presentes"

      - name: Create ZIP
        run: |
          set -e
          cd dist
          zip -r ../SpaceInvadersScreensaver.zip SpaceInvadersScreensaver.saver

      - name: Upload Screensaver ZIP
        uses: actions/upload-artifact@v4
        with:
          name: SpaceInvadersScreensaver
          path: SpaceInvadersScreensaver.zip
          retention-days: 90
